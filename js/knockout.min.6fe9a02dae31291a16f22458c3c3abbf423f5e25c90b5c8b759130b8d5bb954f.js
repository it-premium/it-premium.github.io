validateEmail=(email)=>{re=/^(([^<>()[\]\\.,;:\s@\"]+(\.[^<>()[\]\\.,;:\s@\"]+)*)|(\".+\"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/i;return re.test(email);};async function postData(url='',data={}){const response=await fetch(url,{method:'POST',mode:'cors',credentials:'omit',headers:{'Content-Type':'application/json'},redirect:'follow',referrerPolicy:'no-referrer',body:data});return await response.json();}
function Package(obj){var self=this;self.name=obj.id;self.value=ko.observable(obj.value||0);self.features=obj.features;self.rate=obj.rate;}
function Customer(){self=this;self.name=ko.observable('');self.nameValid=ko.observable(true);self.company=ko.observable('');self.phone=ko.observable('');self.email=ko.observable('');self.emailValid=ko.observable(true);self.validateName=()=>{return self.name().length>0;};self.validateEmail=()=>{if(self.name().length==0){return false;};return validateEmail(self.email());};self.validate=()=>{if(!self.validateName()){self.nameValid(false);}else{self.nameValid(true);}
if(!self.validateEmail()){self.emailValid(false);}else{self.emailValid(true);};return self.nameValid()&&self.emailValid();};}
function Proposition(obj){var self=this;self.id=obj.id;self.name=obj.name;self.price=obj.price;self.parent=obj.parent;self.label='proposition_'+obj.id.toString();self.input_name=obj.input_name;self.has_input=obj.has_input;self.value=ko.observable(obj.default_selected||1);self.checked=ko.observable(obj.default_selected);self.incrementCounter=function(){self.value(self.value()+1);self.checked(true);};self.decrementCounter=function(){if(self.value()>1){self.value(self.value()-1);}else{self.value(0);self.checked(false);}};}
var FrontendViewModel=function(){var self=this;self.propositions=ko.observableArray();self.packages=ko.observableArray();self.selectedPropositions=ko.pureComputed(()=>{let propositions=self.propositions().filter(item=>item.checked());let findParent=(id)=>self.propositions().filter(i=>i.id==id)[0];propositions.forEach(i=>{if(i.parent){i.totals=findParent(i.parent).value();}else{i.totals=i.value();}});return propositions;});self.toggler=ko.observable(false);self.burgerActive=ko.observable(false);self.burgerStatus=ko.pureComputed(()=>{if(self.burgerActive()){return "is-active";};return "";});self.customer=new Customer();self.thanksActive=ko.observable(false);self.proposalActive=ko.observable(false);self.proposalActiveClass=ko.pureComputed(()=>{return self.proposalActive()?"is-active":"";});self.proposalSubmit=()=>{if(!self.customer.validate()){return false;};let req={customer:ko.mapping.toJS(self.customer),propositions:ko.mapping.toJS(self.selectedPropositions()),packages:ko.mapping.toJS(self.packages())};postData('https://uhlh3yezw6.execute-api.eu-central-1.amazonaws.com/generate-pdf',JSON.stringify(req)).then((data)=>{console.log(data);self.proposalActive(false);self.thanksActive(true);});};self.toggleProposal=()=>{self.proposalActive(!self.proposalActive());};self.closeProposal=()=>{self.proposalActive(false);self.thanksActive(false);};self.toggleBurger=()=>{self.burgerActive(!self.burgerActive());};self.selectedPackage=(name)=>{return self.packages().filter(item=>item.name==name)[0];};self.toggleBack=()=>{self.toggler(!self.toggler());};self.calculate=function(){let mapper=(item)=>{if(item.checked()){if(item.parent){let parent=self.propositions().filter(i=>i.id==item.parent)[0];return item.price*parent.value();}else{return item.price*item.value();}}else{return 0;}};let map_price=self.propositions().map(mapper);const reducer=(accumulator,currentValue)=>accumulator+currentValue;let sum=map_price.reduce(reducer);self.selectedPackage('start').value(500);self.selectedPackage('classic').value(Math.ceil(sum));self.selectedPackage('gold').value(Math.ceil(sum*1.5));self.selectedPackage('premium').value(Math.ceil(sum*2));self.toggler(!self.toggler());};};window.frontend=new FrontendViewModel();window.packages.forEach(function(item){window.frontend.packages.push(new Package(item));});window.data.forEach(function(item){window.frontend.propositions.push(new Proposition(item));});ko.applyBindings(frontend);